# trade_manager.py
import asyncio
import random
from datetime import datetime

class TradeManager:
    def __init__(self):
        self.balance = 1000.0  # Starting balance for paper trading
        self.positions = []    # Active positions
        self.trade_history = []  # History of executed trades

    async def execute_trade(self, direction: str = None, amount: float = None):
        """
        Execute a simulated trade.
        direction: 'up' or 'down' (optional)
        amount: amount to trade (optional)
        """
        # Simulate market movement
        direction = direction if direction in ["up", "down"] else random.choice(["up", "down"])
        amount = amount if amount else round(self.balance * 0.1, 2)  # default 10% of balance

        # Simulate profit/loss
        price_change = random.uniform(-0.05, 0.05)  # -5% to +5%
        profit_loss = amount * price_change
        self.balance += profit_loss

        # Record trade
        trade = {
            "time": datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S"),
            "direction": direction,
            "amount": amount,
            "profit_loss": round(profit_loss, 2),
            "balance": round(self.balance, 2)
        }
        self.trade_history.append(trade)

        # Return message to Telegram
        msg = (
            f"Trade executed:\n"
            f"Direction: {trade['direction']}\n"
            f"Amount: {trade['amount']}\n"
            f"P/L: {trade['profit_loss']}\n"
            f"Balance: {trade['balance']}\n"
        )
        return msg

    async def monitor_markets(self):
        """
        Background task to simulate continuous market monitoring.
        """
        while True:
            # Placeholder for real market monitoring logic
            # Can be expanded to use real data from Polymarket, BTC, etc.
            await asyncio.sleep(60)  # check every 60 seconds

    def get_balance(self):
        return round(self.balance, 2)

    def get_trade_history(self, limit: int = 10):
        """
        Return last `limit` trades
        """
        return self.trade_history[-limit:]
